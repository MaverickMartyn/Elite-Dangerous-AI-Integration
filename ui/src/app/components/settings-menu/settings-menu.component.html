<mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start">
    <mat-tab>
        <ng-template mat-tab-label>
            <mat-icon class="tab-icon">settings</mat-icon>
            General
        </ng-template>
        <div class="tab-content">
            @if (config && (!config.commander_name || !config.api_key)) {
                <mat-card appearance="outlined" class="welcome-message" style="margin-bottom: 20px;">
                    <mat-card-header>
                        <mat-icon mat-card-avatar color="primary">info</mat-icon>
                        <mat-card-title>Welcome to COVAS:NEXT!</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <p>To get started, please follow our getting started guide <a target="_blank"
                                                                                      rel="noopener noreferrer"
                                                                                      href="https://ratherrude.github.io/Elite-Dangerous-AI-Integration/">here</a>.
                        </p>
                    </mat-card-content>
                </mat-card>
            }
            @if (config) {
                <div class="settings-grid">
                    <mat-form-field>
                        <mat-label>Commander Name</mat-label>
                        <input required matInput [(ngModel)]="config.commander_name"
                               (ngModelChange)="onConfigChange({commander_name: $event})">
                    </mat-form-field>

                    <p>Enter your API key from 
                        <a target="_blank" rel="noopener noreferrer" href="https://platform.openai.com/api-keys">OpenAI</a>, 
                        <a target="_blank" rel="noopener noreferrer" href="https://aistudio.google.com/app/apikey">Google AI Studio</a>, or 
                        <a target="_blank" rel="noopener noreferrer" href="https://openrouter.ai/settings/keys">OpenRouter</a>. 
                        The system will automatically detect the key type and configure settings.</p>
                    <mat-form-field>
                        <mat-label>Main API Key (OpenAI/Openrouter/Google AI Studio)</mat-label>
                        <input required matInput [type]="hideApiKey ? 'password' : 'text'" [(ngModel)]="config.api_key"
                               (ngModelChange)="onApiKeyChange($event)"
                               pattern="^[A-Za-z0-9_.-]+$"
                               #apiKeyInput="ngModel">
                        <button matSuffix mat-icon-button (mousedown)="hideApiKey = false" (mouseup)="hideApiKey = true"
                                (mouseleave)="hideApiKey = true">
                            <mat-icon>{{ hideApiKey ? 'visibility_off' : 'visibility' }}</mat-icon>
                        </button>
                        <mat-hint *ngIf="apiKeyType">Detected: {{ apiKeyType }} - Advanced settings have been configured automatically</mat-hint>
                        <mat-error *ngIf="apiKeyInput.errors?.['pattern']">
                            API key can only contain letters, numbers, underscores, dots, and hyphens
                        </mat-error>
                    </mat-form-field>

                    <p>This setting allows you choose when the AI will listen to you. We recommend using Push-to-Talk to
                        avoid accidental activation. Voice activation should only be used when wearing headphones.</p>
                    <div class="ptt-container">
                        <mat-form-field>
                            <mat-label>Voice Activation Mode</mat-label>
                            <mat-select [value]="config.ptt_var ? 'ptt' : 'continuous'"
                                        (selectionChange)="onConfigChange({ptt_var: $event.value === 'ptt'})">
                                <mat-option value="continuous">Voice Activation</mat-option>
                                <mat-option value="ptt">Push-to-Talk</mat-option>
                            </mat-select>
                        </mat-form-field>
                        @if (config.ptt_var) {
                            <mat-form-field (click)="onAssignPTT()">
                                <mat-label>Push-to-Talk Key</mat-label>
                                <input required matInput [value]="config.ptt_key" readonly>
                                <button matSuffix mat-icon-button>
                                    <mat-icon>keyboard</mat-icon>
                                </button>
                            </mat-form-field>
                            <div class="ptt-extras">
                                <mat-slide-toggle [(ngModel)]="config.ptt_tap_to_talk_var" appTooltip="Turns the Push-to-Talk key into a toggle, so you don't have to hold it."
                                                    (ngModelChange)="onConfigChange({ptt_tap_to_talk_var: $event})">
                                    Tap-to-Talk
                                </mat-slide-toggle>
                                <mat-slide-toggle [(ngModel)]="config.ptt_inverted_var" appTooltip="Inverts the Push-to-Talk key behavior, swapping muting and unmuting."
                                                    (ngModelChange)="onConfigChange({ptt_inverted_var: $event})">
                                    Invert
                                </mat-slide-toggle>
                            </div>
                        }
                    </div>

                    <mat-form-field>
                        <mat-label>Input Device</mat-label>
                        <mat-select [(ngModel)]="config.input_device_name"
                                    (ngModelChange)="onConfigChange({input_device_name: $event})">
                            @for (device of system?.input_device_names; track device) {
                                <mat-option [value]="device">{{ device }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field>
                        <mat-label>Output Device</mat-label>
                        <mat-select [(ngModel)]="config.output_device_name"
                                    (ngModelChange)="onConfigChange({output_device_name: $event})">
                            @for (device of system?.output_device_names; track device) {
                                <mat-option [value]="device">{{ device }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>
            }
        </div>
    </mat-tab>

    <mat-tab>
        <ng-template mat-tab-label>
            <mat-icon class="tab-icon">person</mat-icon>
            Characters
        </ng-template>
        <div class="tab-content">
            @if (config) {
                <div class="settings-grid">
                    <h2>Personality</h2>
                    <div [class.editing-active]="editMode">
                        <!-- Character Management Section -->
                        <div class="character-management-section">
                            <div class="character-selector">
                                <mat-form-field appearance="fill">
                                    <mat-label>Select Character</mat-label>
                                    <mat-select [(value)]="selectedCharacterIndex" (selectionChange)="onCharacterSelect($event.value)" [disabled]="editMode">
                                        <mat-divider *ngIf="config.characters && config.characters.length > 0"></mat-divider>
                                        <mat-option *ngFor="let character of config.characters; let i = index" [value]="i">
                                            {{ character.name }} ({{ character.tts_voice }})
                                            <span class="char-details">
                                                {{ character.personality_preset | slice:0:1 | uppercase }}{{ character.personality_preset | slice:1 }} -
                                                {{ countActiveEvents(character) }} active events
                                            </span>
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                                @if (!editMode) {
                                    <div class="character-display" [class.with-traits]="!isCustomPreset()">
                                        <div class="character-content">
                                            <span class="trait-label">{{getCharacterProperty('name', '')}}:</span>
                                            {{getCharacterProperty('character', '')}}
                                        </div>
                                        @if (!isCustomPreset()) {
                                            <div class="character-traits">
                                                <div class="trait-item">
                                                    <span class="trait-label">Inspiration:</span>
                                                    <span class="trait-value">{{getCharacterProperty('personality_character_inspiration', '')}}</span>
                                                </div>
                                                <div class="trait-item">
                                                    <span class="trait-label">Verbosity:</span>
                                                    <span class="trait-value">{{getCharacterProperty('personality_verbosity', 50)}}%</span>
                                                </div>
                                                <div class="trait-item">
                                                    <span class="trait-label">Vulgarity:</span>
                                                    <span class="trait-value">{{getCharacterProperty('personality_vulgarity', 0)}}%</span>
                                                </div>
                                                <div class="trait-item">
                                                    <span class="trait-label">Empathy:</span>
                                                    <span class="trait-value">{{getCharacterProperty('personality_empathy', 50)}}%</span>
                                                </div>
                                                <div class="trait-item">
                                                    <span class="trait-label">Formality:</span>
                                                    <span class="trait-value">{{getCharacterProperty('personality_formality', 50)}}%</span>
                                                </div>
                                                <div class="trait-item">
                                                    <span class="trait-label">Confidence:</span>
                                                    <span class="trait-value">{{getCharacterProperty('personality_confidence', 50)}}%</span>
                                                </div>
                                                <div class="trait-item">
                                                    <span class="trait-label">Tone:</span>
                                                    <span class="trait-value">{{getCharacterProperty('personality_tone', 'serious')}}</span>
                                                </div>
                                                <div class="trait-item">
                                                    <span class="trait-label">Ethical Alignment:</span>
                                                    <span class="trait-value">{{getCharacterProperty('personality_ethical_alignment', 'neutral')}}</span>
                                                </div>
                                                <div class="trait-item">
                                                    <span class="trait-label">Moral Alignment:</span>
                                                    <span class="trait-value">{{getCharacterProperty('personality_moral_alignment', 'neutral')}}</span>
                                                </div>
                                                <div class="trait-item">
                                                    <span class="trait-label">Knowledge:</span>
                                                    <div class="trait-value">
                                                        <span [class.active]="getCharacterProperty('personality_knowledge_pop_culture', false)">pop culture</span>
                                                        <span [class.active]="getCharacterProperty('personality_knowledge_scifi', false)">sci-fi</span>
                                                        <span [class.active]="getCharacterProperty('personality_knowledge_history', false)">history</span>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }

                                <div class="character-buttons">
                                    <!-- When not in edit mode, show Edit and New buttons -->
                                    @if (!editMode) {
                                        <button mat-raised-button color="primary"
                                                [disabled]="selectedCharacterIndex <= 0"
                                                [matTooltip]="'Edit the selected character and event reactions.'"
                                                (click)="toggleEditMode()">
                                            <mat-icon>edit</mat-icon> Edit
                                        </button>

                                        <button mat-raised-button color="accent" (click)="addNewCharacter()"
                                                [matTooltip]="selectedCharacterIndex <= 0 ? 'Create a new character to allow editing of character traits and prompt' : 'Create new character.'">
                                            <mat-icon>add</mat-icon> New

                                        </button>

                                        <button mat-raised-button color="accent" 
                                                (click)="duplicateSelectedCharacter()"
                                                [matTooltip]="selectedCharacterIndex <= 0 ? 'Duplicate this character. You can edit character traits after duplicating.': 'Duplicate this character.'">
                                            <mat-icon>content_copy</mat-icon> Duplicate
                                        </button>

                                        <button mat-raised-button color="warn"
                                                [disabled]="selectedCharacterIndex <= 0"
                                                (click)="deleteSelectedCharacter()"
                                                [matTooltip]="'Delete current character.'">
                                            <mat-icon>delete</mat-icon> Delete
                                        </button>
                                    }

                                    <!-- When in edit mode, show Save and Cancel buttons -->
                                    @if (editMode) {
                                        <button mat-raised-button color="primary" (click)="saveCurrentAsCharacter()"
                                                [matTooltip]="'Save character.'" >
                                            <mat-icon>save</mat-icon> Save
                                        </button>

                                        <button mat-raised-button (click)="cancelEditMode()"
                                                [matTooltip]="'Cancel current edit.'" >

                                            <mat-icon>cancel</mat-icon> Cancel
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Character settings - only visible when editing -->
                        <div id="character-creation" *ngIf="editMode">
                            <!-- Character Name -->
                            <div class="character-settings">
                                <div class="trait-container">
                                    <div class="trait-input">
                                        <mat-form-field appearance="outline">
                                            <mat-label>Character Name</mat-label>
                                            <input matInput
                                                [ngModel]="getCharacterProperty('name', '') || getCharacterProperty('personality_name', '')"
                                                [ngModelOptions]="{updateOn: 'blur'}"
                                                (ngModelChange)="updateActiveCharacterProperty('name', $event)">
                                        </mat-form-field>
                                    </div>
                                    <div class="trait-input">
                                        <!-- Character Language -->
                                        <mat-form-field appearance="outline">
                                            <mat-label>Character Language</mat-label>
                                            <input matInput
                                                [ngModel]="getCharacterProperty('personality_language', 'English')"
                                                [ngModelOptions]="{updateOn: 'blur'}"
                                                (ngModelChange)="onTraitChange('personality_language', $event)">
                                        </mat-form-field>
                                    </div>
                                    <div class="trait-select">
                                        <!-- Voice selection -->
                                        <mat-form-field>
                                            <mat-label>Voice</mat-label>
                                            @if (config.tts_provider === 'openai') {
                                                <mat-select [ngModel]="getCharacterProperty('tts_voice', 'nova')"
                                                        (ngModelChange)="onTraitChange('tts_voice', $event)">
                                                    <mat-option value="alloy">Alloy - Neutral, versatile voice</mat-option>
                                                    <mat-option value="ash">Ash - New voice</mat-option>
                                                    <mat-option value="ballad">Ballad - New voice</mat-option>
                                                    <mat-option value="coral">Coral - New voice</mat-option>
                                                    <mat-option value="echo">Echo - Deeper, experienced voice</mat-option>
                                                    <mat-option value="fable">Fable - Warm, soft-spoken voice</mat-option>
                                                    <mat-option value="nova">Nova - Bright, friendly voice</mat-option>
                                                    <mat-option value="onyx">Onyx - Deep, authoritative voice</mat-option>
                                                    <mat-option value="sage">Sage - New voice</mat-option>
                                                    <mat-option value="shimmer">Shimmer - Clear, warm voice</mat-option>
                                                </mat-select>
                                            } @else if (config.tts_provider === 'edge-tts') {
                                                <mat-select [ngModel]="getCharacterProperty('tts_voice', 'en-US-AvaMultilingualNeural')"
                                                        (selectionChange)="onVoiceSelectionChange($event.value)">
                                                    @if (isCustomVoice(getCharacterProperty('tts_voice', 'en-US-AvaMultilingualNeural'))) {
                                                        <mat-option [value]="getCharacterProperty('tts_voice', 'en-US-AvaMultilingualNeural')" style="font-style: italic">
                                                            {{ getVoiceDisplayName(getCharacterProperty('tts_voice', 'en-US-AvaMultilingualNeural')) }}
                                                        </mat-option>
                                                        <mat-divider class="custom-voice-divider"></mat-divider>
                                                    }
                                                    <mat-optgroup label="English - United States">
                                                        <mat-option value="en-US-AvaMultilingualNeural">Ava Multilingual (Female)</mat-option>
                                                        <mat-option value="en-US-AndrewMultilingualNeural">Andrew Multilingual (Male)</mat-option>
                                                        <mat-option value="en-US-AriaNeural">Aria (Female) - Positive, Confident</mat-option>
                                                        <mat-option value="en-US-AnaNeural">Ana (Female) - Cute</mat-option>
                                                        <mat-option value="en-US-ChristopherNeural">Christopher (Male) - Reliable, Authority</mat-option>
                                                        <mat-option value="en-US-EricNeural">Eric (Male) - Rational</mat-option>
                                                        <mat-option value="en-US-GuyNeural">Guy (Male) - Passion</mat-option>
                                                        <mat-option value="en-US-JennyNeural">Jenny (Female) - Friendly, Considerate</mat-option>
                                                        <mat-option value="en-US-MichelleNeural">Michelle (Female) - Friendly, Pleasant</mat-option>
                                                        <mat-option value="en-US-RogerNeural">Roger (Male) - Lively</mat-option>
                                                        <mat-option value="en-US-SteffanNeural">Steffan (Male) - Rational</mat-option>
                                                    </mat-optgroup>
                                                    <mat-optgroup label="English - United Kingdom">
                                                        <mat-option value="en-GB-LibbyNeural">Libby (Female)</mat-option>
                                                        <mat-option value="en-GB-MaisieNeural">Maisie (Female)</mat-option>
                                                        <mat-option value="en-GB-RyanNeural">Ryan (Male)</mat-option>
                                                        <mat-option value="en-GB-SoniaNeural">Sonia (Female)</mat-option>
                                                        <mat-option value="en-GB-ThomasNeural">Thomas (Male)</mat-option>
                                                    </mat-optgroup>
                                                    <mat-optgroup label="English - Australia">
                                                        <mat-option value="en-AU-NatashaNeural">Natasha (Female)</mat-option>
                                                        <mat-option value="en-AU-WilliamNeural">William (Male)</mat-option>
                                                    </mat-optgroup>
                                                    <mat-option value="show-all-voices">Show All Voices...</mat-option>
                                                </mat-select>
                                            } @else {
                                                <input matInput [ngModel]="getCharacterProperty('tts_voice', 'nova')"
                                                    (ngModelChange)="onTraitChange('tts_voice', $event)">
                                            }
                                        </mat-form-field>
                                    </div>
                                    <div class="trait-select">
                                        <!-- Voice speed -->
                                        @if (!voiceInstructionSupportedModels.includes(config.tts_model_name)) {
                                            <div class="trait-select lowWidth">
                                                <mat-form-field>
                                                    <mat-label>Speed</mat-label>
                                                    <input matInput [ngModel]="getCharacterProperty('tts_speed', '1,2')"
                                                           (ngModelChange)="onTraitChange('tts_speed', $event)">
                                                </mat-form-field>
                                            </div>
                                        }

                                        <!-- TTS Prompt -->
                                        @if (voiceInstructionSupportedModels.includes(config.tts_model_name)) {
                                            <div class="trait-select">
                                                <mat-hint><b>Voice instructions</b><br>Enter a detailed description of how you want your voice to sound.<br>You can include things such as: accent, emotional range, tone, impressions and speed.<br>
                                                    Warning: This will increase the cost of each query!</mat-hint>
                                                <mat-form-field>
                                                    <mat-label>Voice Tone Instructions</mat-label>
                                                    <textarea matInput [ngModel]="getCharacterProperty('tts_prompt', '')"
                                                            (ngModelChange)="onTraitChange('tts_prompt', $event)"></textarea>

                                                </mat-form-field>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Personality Preset -->
                            <div class="trait-container">
                                <div class="trait-select">
                                    <mat-form-field appearance="fill">
                                        <mat-label>Personality Preset</mat-label>
                                        <mat-select [value]="getCharacterProperty('personality_preset', 'default')" (selectionChange)="applyPersonalityPreset($event.value)"  [matTooltip]="'Select a predefined personality role or write your own.'"
                                                      tooltipPosition="right">>
                                            <mat-option value="default">Default</mat-option>
                                            <mat-option value="custom">Write your own prompt</mat-option>
                                            <mat-option disabled>--- Elite: Dangerous Roles ---</mat-option>
                                            <mat-option value="explorer">Explorer</mat-option>
                                            <mat-option value="trader">Trader</mat-option>
                                            <mat-option value="miner">Miner</mat-option>
                                            <mat-option value="bountyHunter">Bounty Hunter</mat-option>
                                            <mat-option value="pirate">Pirate</mat-option>
                                            <mat-option value="smuggler">Smuggler</mat-option>
                                            <mat-option value="mercenary">Mercenary</mat-option>
                                            <mat-option value="missionRunner">Mission Runner</mat-option>
                                            <mat-option value="passengerTransporter">Passenger Transporter</mat-option>
                                            <mat-option value="powerplayAgent">Powerplay Agent</mat-option>
                                            <mat-option value="axCombatPilot">AX Combat Pilot</mat-option>
                                            <mat-option value="pvpCombatant">PvP Combatant</mat-option>
                                            <mat-option value="pveCombatant">PvE Combatant</mat-option>
                                            <mat-option value="salvager">Salvager</mat-option>
                                            <mat-option value="cannonResearcher">Cannon Researcher</mat-option>
                                            <mat-option value="fuelRat">Fuel Rat/Support</mat-option>
                                            <mat-option value="fleetCarrierOperator">Fleet Carrier Operator</mat-option>
                                            <mat-option value="bgsPlayer">BGS Player</mat-option>
                                            <mat-option value="racer">Race Pilot</mat-option>
                                            <mat-option disabled>--- Roleplaying Characters ---</mat-option>
                                            <mat-option value="diplomat">Diplomat</mat-option>
                                            <mat-option value="spy">Spy / Infiltrator</mat-option>
                                            <mat-option value="cultLeader">Cult Leader</mat-option>
                                            <mat-option value="rogueAI">Rogue AI / Synthetic Being</mat-option>
                                            <mat-option value="xenologist">Xenologist</mat-option>
                                            <mat-option value="vigilante">Renegade Cop / Vigilante</mat-option>
                                            <mat-option value="warCorrespondent">War Correspondent</mat-option>
                                            <mat-option value="propagandist">Propagandist</mat-option>
                                            <mat-option value="pirateLord">Pirate Lord / Crime Boss</mat-option>
                                            <mat-option value="veteran">Disillusioned Veteran</mat-option>
                                            <mat-option value="freedomFighter">Freedom Fighter</mat-option>
                                            <mat-option value="hermit">Hermit / Space Nomad</mat-option>
                                            <mat-option value="corporate">Corporate Operative</mat-option>
                                            <mat-option value="zealot">Religious Zealot</mat-option>
                                            <mat-option value="historian">Historian / Archivist</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </div>
                            
                            <!-- Character settings when preset is not custom -->
                            @if (!isCustomPreset()) {
                                <div class="personality-settings">
                                    <div class="trait-container">
                                        <!-- Character Inspiration -->
                                        <div class="trait-select">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Character Inspiration</mat-label>
                                                <input matInput
                                                    [ngModel]="getCharacterProperty('personality_character_inspiration', '')"
                                                    [ngModelOptions]="{updateOn: 'blur'}"
                                                    (ngModelChange)="onTraitChange('character_inspiration', $event)">
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <div class="trait-container">
                                        <!-- Verbosity Setting -->
                                        <div class="trait-select">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Verbosity</mat-label>
                                                <mat-select [ngModel]="getCharacterProperty('personality_verbosity', 50)"
                                                    (ngModelChange)="onTraitChange('verbosity', $event)">
                                                    <mat-option [value]="0">Minimal</mat-option>
                                                    <mat-option [value]="25">Brief</mat-option>
                                                    <mat-option [value]="50">Balanced</mat-option>
                                                    <mat-option [value]="75">Detailed</mat-option>
                                                    <mat-option [value]="100">Verbose</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>

                                        <!-- Tone Setting -->
                                        <div class="trait-select">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Tone</mat-label>
                                                <mat-select [ngModel]="getCharacterProperty('personality_tone', 'serious')"
                                                    (ngModelChange)="onTraitChange('tone', $event)">
                                                    <mat-option value="serious">Serious</mat-option>
                                                    <mat-option value="humorous">Humorous</mat-option>
                                                    <mat-option value="sarcastic">Sarcastic</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>

                                        <!-- Vulgarity Setting -->
                                        <div class="trait-select">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Vulgarity</mat-label>
                                                <mat-select [ngModel]="getCharacterProperty('personality_vulgarity', 0)"
                                                    (ngModelChange)="onTraitChange('vulgarity', $event)">
                                                    <mat-option [value]="0">None</mat-option>
                                                    <mat-option [value]="25">Mild</mat-option>
                                                    <mat-option [value]="50">Moderate</mat-option>
                                                    <mat-option [value]="75">Strong</mat-option>
                                                    <mat-option [value]="100">Extreme</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <div class="trait-container">
                                        <!-- Empathy Level -->
                                        <div class="trait-select">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Empathy</mat-label>
                                                <mat-select [ngModel]="getCharacterProperty('personality_empathy', 50)"
                                                    (ngModelChange)="onTraitChange('empathy', $event)">
                                                    <mat-option [value]="0">Cold</mat-option>
                                                    <mat-option [value]="25">Detached</mat-option>
                                                    <mat-option [value]="50">Balanced</mat-option>
                                                    <mat-option [value]="75">Caring</mat-option>
                                                    <mat-option [value]="100">Highly Empathetic</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>

                                        <!-- Formality Level -->
                                        <div class="trait-select">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Formality</mat-label>
                                                <mat-select [ngModel]="getCharacterProperty('personality_formality', 50)"
                                                    (ngModelChange)="onTraitChange('formality', $event)">
                                                    <mat-option [value]="0">Casual</mat-option>
                                                    <mat-option [value]="25">Relaxed</mat-option>
                                                    <mat-option [value]="50">Balanced</mat-option>
                                                    <mat-option [value]="75">Professional</mat-option>
                                                    <mat-option [value]="100">Formal</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>

                                        <!-- Confidence Level -->
                                        <div class="trait-select">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Confidence</mat-label>
                                                <mat-select [ngModel]="getCharacterProperty('personality_confidence', 50)"
                                                    (ngModelChange)="onTraitChange('confidence', $event)">
                                                    <mat-option [value]="0">Uncertain</mat-option>
                                                    <mat-option [value]="25">Tentative</mat-option>
                                                    <mat-option [value]="50">Balanced</mat-option>
                                                    <mat-option [value]="75">Confident</mat-option>
                                                    <mat-option [value]="100">Authoritative</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <div class="trait-container">
                                        <!-- Ethical Axis (Law vs. Chaos) -->
                                        <div class="trait-select">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Ethical Alignment</mat-label>
                                                <mat-select [ngModel]="getCharacterProperty('personality_ethical_alignment', 'neutral')"
                                                    (ngModelChange)="onTraitChange('ethical_alignment', $event)">
                                                    <mat-option value="lawful">Lawful (Order, Rules, Structure)</mat-option>
                                                    <mat-option value="neutral">Neutral (Balance, Pragmatism)</mat-option>
                                                    <mat-option value="chaotic">Chaotic (Freedom, Flexibility, Spontaneity)</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>

                                        <!-- Moral Axis (Good vs. Evil) -->
                                        <div class="trait-select">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Moral Alignment</mat-label>
                                                <mat-select [ngModel]="getCharacterProperty('personality_moral_alignment', 'neutral')"
                                                    (ngModelChange)="onTraitChange('moral_alignment', $event)">
                                                    <mat-option value="good">Good (Altruism, Compassion)</mat-option>
                                                    <mat-option value="neutral">Neutral (Self-Interest, Balance)</mat-option>
                                                    <mat-option value="evil">Evil (Selfishness, Ruthlessness)</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>

                                    <!-- Knowledge Areas -->
                                    <div class="knowledge-areas">
                                        <label class="knowledge-label">Knowledge Areas</label>
                                        <div class="knowledge-checkboxes">
                                            <mat-checkbox [ngModel]="getCharacterProperty('personality_knowledge_pop_culture', false)"
                                                        (ngModelChange)="onTraitChange('knowledge_pop_culture', $event)">Pop Culture</mat-checkbox>
                                            <mat-checkbox [ngModel]="getCharacterProperty('personality_knowledge_scifi', false)"
                                                        (ngModelChange)="onTraitChange('knowledge_scifi', $event)">Sci-Fi</mat-checkbox>
                                            <mat-checkbox [ngModel]="getCharacterProperty('personality_knowledge_history', false)"
                                                        (ngModelChange)="onTraitChange('knowledge_history', $event)">History</mat-checkbox>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Character Textarea - always visible when editing -->
                            @if (!isCustomPreset()) {
                                <div class="character-display">
                                    <h4>Character Prompt</h4>
                                    <div class="character-content">{{getCharacterProperty('character', '')}}</div>
                                </div>
                            } @else {
                                <div class="trait-container">
                                <mat-form-field>
                                    <mat-label>Character</mat-label>
                                    <textarea matInput [ngModel]="getCharacterProperty('character', '')"
                                            (ngModelChange)="onTraitChange('character', $event)"
                                            [readonly]="!isCustomPreset()"
                                            rows="10"></textarea>
                                </mat-form-field>
                            </div>
                            }
                        </div>
                    </div>

                    @if (editMode) {
                    <h2>Reactions</h2>

                        <mat-slide-toggle [ngModel]="getEventProperty('event_reaction_enabled_var', false)"
                                          (ngModelChange)="onEventReactionFeatureToggle('event_reaction_enabled_var', $event)">
                            Enable Event Reactions
                        </mat-slide-toggle>
                        <p>Events are caused by the game and your actions within it. By default, the AI will react to those
                            events and provide additional details or commentary. You can customize the reactions in the <a
                                    href="#" (click)="eventReactionsSection.scrollIntoView()">Customize Event Reactions</a>
                            section below.</p>

                        <h3 #eventReactionsSection>Customize Event Reactions</h3>
                        <p>This section allows you to customize the event reactions for the game and will allow you to make
                            the AI react less or more often.</p>

                        @if (getEventProperty('event_reaction_enabled_var', false)) {
                            <div class="event-search-and-reset">
                                <mat-form-field class="search-box" subscriptSizing="dynamic">
                                    <mat-label>Search events</mat-label>
                                    <input matInput [(ngModel)]="eventSearchQuery"
                                           (ngModelChange)="filterEvents($event)"
                                           placeholder="Type to search events...">
                                    <button *ngIf="eventSearchQuery" matSuffix mat-icon-button (click)="clearEventSearch()">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </mat-form-field>

                                <button mat-raised-button color="warn" (click)="resetGameEvents()"
                                        [matTooltip]="'Reset the event reactions to the default set.'">
                                    <mat-icon>restart_alt</mat-icon> Reset to Defaults

                                </button>
                            </div>

                            <mat-accordion multi="false">
                                @for (section of filteredGameEvents | keyvalue:orderByKey; track section.key) {
                                    <mat-expansion-panel [expanded]="isSectionExpanded(section.key)"
                                                         (afterExpand)="onSectionToggled(section.key)"
                                                         (afterCollapse)="onSectionToggled(null)">
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>
                                                {{ section.key }}
                                            </mat-panel-title>
                                        </mat-expansion-panel-header>
                                        @for (e of section.value | keyvalue:orderByKey; track e.key) {
                                            <mat-slide-toggle
                                                  [(ngModel)]="e.value"
                                                  (ngModelChange)="onEventConfigChange(section.key, e.key, $event)"
                                                  [appTooltip]="GameEventTooltips[e.key]"
                                                  tooltipPosition="right"
                                                >
                                                  {{ e.key }}
                                            </mat-slide-toggle>
                                            @if (e.key === "ProspectedAsteroid") {
                                                <mat-form-field>
                                                    <mat-label>React to material</mat-label>
                                                    <mat-select multiple
                                                               [value]="getMaterialsArray(getEventProperty('react_to_material', ''))"
                                                               (selectionChange)="onMaterialsChange($event.value)">
                                                        <mat-option value="Alexandrite">Alexandrite</mat-option>
                                                        <mat-option value="Benitoite">Benitoite</mat-option>
                                                        <mat-option value="Bromellite">Bromellite</mat-option>
                                                        <mat-option value="Grandidierite">Grandidierite</mat-option>
                                                        <mat-option value="LowTemperatureDiamond">LowTemperatureDiamond</mat-option>
                                                        <mat-option value="Monazite">Monazite</mat-option>
                                                        <mat-option value="Musgravite">Musgravite</mat-option>
                                                        <mat-option value="Opal">Opal</mat-option>
                                                        <mat-option value="Painite">Painite</mat-option>
                                                        <mat-option value="Platinum">Platinum</mat-option>
                                                        <mat-option value="Rhodplumsite">Rhodplumsite</mat-option>
                                                        <mat-option value="Serendibite">Serendibite</mat-option>
                                                        <mat-option value="Tritium">Tritium</mat-option>
                                                    </mat-select>
                                                </mat-form-field>
                                            }
                                            @if (e.key === "InDanger") {
                                            <div class="event-suboption">
                                                <mat-slide-toggle
                                                  [ngModel]="getEventProperty('react_to_danger_mining_var', false)"
                                                  (ngModelChange)="onEventReactionFeatureToggle('react_to_danger_mining_var', $event)"
                                                  [appTooltip]="'React to in danger whilst mining or not.'"
                                                  tooltipPosition="right"
                                                >
                                                  React while mining
                                                </mat-slide-toggle>
                                              </div>

                                            <div class="event-suboption">
                                                <mat-slide-toggle
                                                  [ngModel]="getEventProperty('react_to_danger_onfoot_var', false)"
                                                  (ngModelChange)="onEventReactionFeatureToggle('react_to_danger_onfoot_var', $event)"
                                                  [appTooltip]="'React to in danger whilst on foot or not.'"
                                                  tooltipPosition="right"
                                                >
                                                  React while on-foot
                                                </mat-slide-toggle>
                                              </div>

                                            <div class="event-suboption">
                                                <mat-slide-toggle
                                                  [ngModel]="getEventProperty('react_to_danger_supercruise_var', false)"
                                                  (ngModelChange)="onEventReactionFeatureToggle('react_to_danger_supercruise_var', $event)"
                                                  [appTooltip]="'React to in danger whilst in supercruise or not.'"
                                                  tooltipPosition="right"
                                                >
                                                  React while in supercruise
                                                </mat-slide-toggle>
                                              </div>
                                            }

                                            @if (e.key === "ReceiveText") {
                                            <div class="event-suboption">
                                                <mat-slide-toggle
                                                  [ngModel]="getEventProperty('react_to_text_local_var', false)"
                                                  (ngModelChange)="onEventReactionFeatureToggle('react_to_text_local_var', $event)"
                                                  [appTooltip]="'React to local text or not'"
                                                  tooltipPosition="right"
                                                >
                                                React to local text
                                                </mat-slide-toggle>
                                            </div>

                                            <div class="event-suboption">
                                                <mat-slide-toggle
                                                  [ngModel]="getEventProperty('react_to_text_starsystem_var', false)"
                                                  (ngModelChange)="onEventReactionFeatureToggle('react_to_text_starsystem_var', $event)"
                                                  [appTooltip]="'React to starsystem text or not'"
                                                  tooltipPosition="right"
                                                >
                                                  React to starsystem text
                                                </mat-slide-toggle>
                                              </div>

                                            <div class="event-suboption">
                                                <mat-slide-toggle
                                                  [ngModel]="getEventProperty('react_to_text_squadron_var', false)"
                                                  (ngModelChange)="onEventReactionFeatureToggle('react_to_text_squadron_var', $event)"
                                                  [appTooltip]="'React to squadron text or not'"
                                                  tooltipPosition="right"
                                                >
                                                  React to squadron text
                                                </mat-slide-toggle>
                                              </div>

                                            <div class="event-suboption">
                                                <mat-slide-toggle
                                                  [ngModel]="getEventProperty('react_to_text_npc_var', false)"
                                                  (ngModelChange)="onEventReactionFeatureToggle('react_to_text_npc_var', $event)"
                                                  [appTooltip]="'React to npc text or not'"
                                                  tooltipPosition="right"
                                                >
                                                  React to NPC text
                                                </mat-slide-toggle>
                                              </div>
                                            }

                                            @if (e.key === "Idle") {
                                                <mat-form-field>
                                                    <mat-label>Idle Timeout (seconds)</mat-label>
                                                    <input matInput type="number" 
                                                           [ngModel]="getEventProperty('idle_timeout_var', 300)"
                                                           (ngModelChange)="onEventPropertyChange('idle_timeout_var', $event)"
                                                           min="60">
                                                    <mat-hint>Time in seconds before AI considers you idle (min 60)</mat-hint>
                                                </mat-form-field>
                                            }
                                            <br/>
                                        }
                                    </mat-expansion-panel>
                                }
                            </mat-accordion>
                        }
                    }

                    <h2>Conversation History</h2>
                    <div class="clear_history">
                        <p>This will clear the entire conversation history with the AI. If you change the character, you may want to reset the conversation history, so
                        the AI starts with a blank slate.</p>
                        <button mat-stroked-button color="warn" (click)="onClearHistory()">
                            <mat-icon>delete_sweep</mat-icon>
                            Clear History
                        </button>
                    </div>
                </div>
            }
        </div>
    </mat-tab>

    <mat-tab>
        <ng-template mat-tab-label>
            <mat-icon class="tab-icon">psychology</mat-icon>
            Behavior
        </ng-template>
        <div class="tab-content">
            @if (config) {
                <div class="settings-grid">
                    <h2>Actions</h2>
                    <mat-slide-toggle [ngModel]="config.tools_var && config.game_actions_var"
                                      (ngModelChange)="onConfigChange({game_actions_var: $event})"
                                      [disabled]="!config.tools_var">
                        Enable Game Actions
                    </mat-slide-toggle>
                    <p>Game actions are performed by the AI on your behalf, like deploying the landing gear or opening
                        the galaxy map.</p>
                    <mat-slide-toggle [ngModel]="config.tools_var && config.web_search_actions_var"
                                      (ngModelChange)="onConfigChange({web_search_actions_var: $event})"
                                      [disabled]="!config.tools_var">
                        Enable Web Actions
                    </mat-slide-toggle>
                    <p>Web actions are performed by the AI on your behalf and allow you to search the web for
                        information, like searching for stations selling a specific commodity or material.</p>
                    <mat-slide-toggle [ngModel]="config.tools_var && config.use_action_cache_var"
                                      (ngModelChange)="onConfigChange({use_action_cache_var: $event})"
                                      [disabled]="!config.tools_var">
                        Enable Action Cache
                    </mat-slide-toggle>
                    <p>The action cache allows the AI to learn from previous interactions and reuse actions for similar
                        inputs, making responses faster and more consistent.</p>
                    <!--<h2>Quality of Life</h2>
                    <mat-slide-toggle [ngModel]="config.qol_autobrake"
                                      (ngModelChange)="onConfigChange({qol_autobrake: $event})">
                        Auto Brake
                    </mat-slide-toggle>
                    <p>Automatically brake when when entering a new star system.</p>
                    <mat-slide-toggle [ngModel]="config.qol_autoscan"
                                      (ngModelChange)="onConfigChange({qol_autoscan: $event})">
                        Auto Scan
                    </mat-slide-toggle>
                    <p>Automatically perform a system scan when entering a new star system.</p>-->
                </div>
            }
        </div>
    </mat-tab>

    <mat-tab>
        <ng-template mat-tab-label>
            <mat-icon class="tab-icon">tune</mat-icon>
            Advanced
        </ng-template>
        <div class="tab-content">
            @if (config) {
                <div class="settings-grid">
                    <p>This section allows you to customize advanced settings. It is recommended to leave these settings
                        at their default values unless you know what you are doing.</p>
                    <h3>LLM Settings</h3>
                    <mat-form-field>
                        <mat-label>LLM Provider</mat-label>
                        <mat-select [(ngModel)]="config.llm_provider"
                                    (ngModelChange)="onConfigChange({llm_provider: $event})">
                            <mat-option value="openai">OpenAI</mat-option>
                            <mat-option value="openrouter">OpenRouter</mat-option>
                            <mat-option value="google-ai-studio">Google AI Studio</mat-option>
                            <mat-option value="local-ai-server">Local AIServer</mat-option>
                            <mat-option value="custom">Custom</mat-option>
                        </mat-select>
                    </mat-form-field>
                    @if (config.llm_provider === "openai")
                    {
                        <mat-form-field>
                            <mat-label>LLM Model Name</mat-label>
                            <input matInput [(ngModel)]="config.llm_model_name"
                                   (ngModelChange)="onConfigChange({llm_model_name: $event})">
                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>Override LLM API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.llm_api_key"
                                   (ngModelChange)="onConfigChange({llm_api_key: $event})">
                        </mat-form-field>
                    }
                    @if (config.llm_provider === "openrouter")
                    {
                        <mat-form-field>
                            <mat-label>LLM Model Name</mat-label>
                            <input matInput [(ngModel)]="config.llm_model_name"
                                   (ngModelChange)="onConfigChange({llm_model_name: $event})">
                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>Override LLM API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.llm_api_key"
                                   (ngModelChange)="onConfigChange({llm_api_key: $event})">
                        </mat-form-field>

                        <label>
                            <mat-slide-toggle [(ngModel)]="config.tools_var"
                                              (ngModelChange)="onConfigChange({tools_var: $event})">
                                Allow Actions (Tool Use)
                            </mat-slide-toggle>
                        </label>
                    }
                    @if (config.llm_provider === "google-ai-studio")
                    {
                        <mat-form-field>
                            <mat-label>LLM Model Name</mat-label>
                            <input matInput [(ngModel)]="config.llm_model_name"
                                   (ngModelChange)="onConfigChange({llm_model_name: $event})">
                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>Override LLM API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.llm_api_key"
                                   (ngModelChange)="onConfigChange({llm_api_key: $event})">
                        </mat-form-field>
                    }
                    @if (config.llm_provider === "local-ai-server")
                    {
                        <mat-form-field>
                            <mat-label>LLM Endpoint</mat-label>
                            <input matInput [(ngModel)]="config.llm_endpoint"
                                   (ngModelChange)="onConfigChange({llm_endpoint: $event})">
                        </mat-form-field>

                        <label>
                            <mat-slide-toggle [(ngModel)]="config.tools_var"
                                              (ngModelChange)="onConfigChange({tools_var: $event})">
                                Allow Actions (Tool Use)
                            </mat-slide-toggle>
                        </label>
                    }
                    @if (config.llm_provider === "custom")
                    {

                        <mat-form-field>
                            <mat-label>LLM Endpoint</mat-label>
                            <input matInput [(ngModel)]="config.llm_endpoint"
                                   (ngModelChange)="onConfigChange({llm_endpoint: $event})">
                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>LLM Model Name</mat-label>
                            <input matInput [(ngModel)]="config.llm_model_name"
                                   (ngModelChange)="onConfigChange({llm_model_name: $event})">
                        </mat-form-field>

                        <mat-form-field>
                            <mat-label>Override LLM API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.llm_api_key"
                                   (ngModelChange)="onConfigChange({llm_api_key: $event})">
                        </mat-form-field>


                        <label>
                            <mat-slide-toggle [(ngModel)]="config.tools_var"
                                              (ngModelChange)="onConfigChange({tools_var: $event})">
                                Allow Actions (Tool Use)
                            </mat-slide-toggle>
                        </label>
                    }
                    

                    <hr>
                    <h3>STT Settings</h3>
                    <mat-form-field>
                        <mat-label>STT Provider</mat-label>
                        <mat-select [(ngModel)]="config.stt_provider"
                                    (ngModelChange)="onConfigChange({stt_provider: $event})">
                            <mat-option value="openai">OpenAI</mat-option>
                            <mat-option value="google-ai-studio">Google AI Studio (Multi-Modal)</mat-option>
                            <mat-option value="local-ai-server">Local AIServer</mat-option>
                            <mat-option value="custom">Custom</mat-option>
                            <mat-option value="custom-multi-modal">Custom Multi-Modal</mat-option>
                            <mat-option value="none">None</mat-option>
                        </mat-select>
                    </mat-form-field>
                    @if (config.stt_provider === "openai") {
                        <mat-form-field>
                            <mat-label>STT Model Name</mat-label>
                            <input matInput [(ngModel)]="config.stt_model_name"
                                   (ngModelChange)="onConfigChange({stt_model_name: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>Override STT API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.stt_api_key"
                                   (ngModelChange)="onConfigChange({stt_api_key: $event})">
                        </mat-form-field>
                    }
                    @if (config.stt_provider === "google-ai-studio") {
                        <mat-form-field>
                            <mat-label>STT Model Name</mat-label>
                            <input matInput [(ngModel)]="config.stt_model_name"
                                   (ngModelChange)="onConfigChange({stt_model_name: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>Override STT API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.stt_api_key"
                                   (ngModelChange)="onConfigChange({stt_api_key: $event})">
                        </mat-form-field>
                    }
                    @if (config.stt_provider === "local-ai-server") {
                        <mat-form-field>
                            <mat-label>STT Endpoint</mat-label>
                            <input matInput [(ngModel)]="config.stt_endpoint"
                                   (ngModelChange)="onConfigChange({stt_endpoint: $event})">
                        </mat-form-field>
                    }
                    @if (config.stt_provider === "custom") {
                        <mat-form-field>
                            <mat-label>STT Endpoint</mat-label>
                            <input matInput [(ngModel)]="config.stt_endpoint"
                                   (ngModelChange)="onConfigChange({stt_endpoint: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>STT Model Name</mat-label>
                            <input matInput [(ngModel)]="config.stt_model_name"
                                   (ngModelChange)="onConfigChange({stt_model_name: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>Override STT API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.stt_api_key"
                                   (ngModelChange)="onConfigChange({stt_api_key: $event})">
                        </mat-form-field>
                    }
                    @if (config.stt_provider === "custom-multi-modal") {
                        <mat-form-field>
                            <mat-label>STT Endpoint</mat-label>
                            <input matInput [(ngModel)]="config.stt_endpoint"
                                   (ngModelChange)="onConfigChange({stt_endpoint: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>STT Model Name</mat-label>
                            <input matInput [(ngModel)]="config.stt_model_name"
                                   (ngModelChange)="onConfigChange({stt_model_name: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>Override STT API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.stt_api_key"
                                   (ngModelChange)="onConfigChange({stt_api_key: $event})">
                        </mat-form-field>
                    }
                    @if (config.stt_provider === "none") {
                        <p>STT is disabled</p>
                    }


                    <hr>
                    <h3>TTS Settings</h3>
                    <mat-form-field>
                        <mat-label>TTS Provider</mat-label>
                        <mat-select [(ngModel)]="config.tts_provider"
                                    (ngModelChange)="onConfigChange({tts_provider: $event})">
                            <mat-option value="openai">OpenAI</mat-option>
                            <mat-option value="edge-tts">Edge TTS</mat-option>
                            <mat-option value="local-ai-server">Local AIServer</mat-option>
                            <mat-option value="custom">Custom</mat-option>
                            <mat-option value="none">None</mat-option>
                        </mat-select>
                    </mat-form-field>
                    @if (config.tts_provider === "openai") {
                        <mat-form-field>
                            <mat-label>TTS Model Name</mat-label>
                            <input matInput [(ngModel)]="config.tts_model_name"
                                   (ngModelChange)="onConfigChange({tts_model_name: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>TTS Voice</mat-label>
                            <mat-select [ngModel]="getCharacterProperty('tts_voice', 'nova')"
                                      (ngModelChange)="onTraitChange('tts_voice', $event)">
                                <mat-option value="alloy">Alloy - Neutral, versatile voice</mat-option>
                                <mat-option value="ash">Ash - New voice</mat-option>
                                <mat-option value="ballad">Ballad - New voice</mat-option>
                                <mat-option value="coral">Coral - New voice</mat-option>
                                <mat-option value="echo">Echo - Deeper, experienced voice</mat-option>
                                <mat-option value="fable">Fable - Warm, soft-spoken voice</mat-option>
                                <mat-option value="nova">Nova - Bright, friendly voice</mat-option>
                                <mat-option value="onyx">Onyx - Deep, authoritative voice</mat-option>
                                <mat-option value="sage">Sage - New voice</mat-option>
                                <mat-option value="shimmer">Shimmer - Clear, warm voice</mat-option>
                            </mat-select>
                        </mat-form-field>
                        @if (!voiceInstructionSupportedModels.includes(config.tts_model_name)) {
                        <mat-form-field>
                            <mat-label>TTS Speed</mat-label>
                            <input matInput [ngModel]="getCharacterProperty('tts_speed', '1,2')"
                                   (ngModelChange)="onTraitChange('tts_speed', $event)">
                        </mat-form-field>
                        }
                        <mat-form-field>
                            <mat-label>Override TTS API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.tts_api_key"
                                   (ngModelChange)="onConfigChange({tts_api_key: $event})">
                        </mat-form-field>
                        @if (voiceInstructionSupportedModels.includes(config.tts_model_name)) {
                        <mat-hint>Voice instructions: Enter a detailed description of how you want your voice to sound. You can include things such as: accent, emotional range, tone, impressions and speed.<br>
                            Warning: This will increase the cost of each query!</mat-hint>
                        <mat-form-field>
                            <mat-label>Voice Tone Instructions</mat-label>
                            <textarea matInput [ngModel]="getCharacterProperty('tts_prompt', '')"
                                   (ngModelChange)="onTraitChange('tts_prompt', $event)"></textarea>

                        </mat-form-field>
                        }
                    }
                    @if (config.tts_provider === "edge-tts") {
                        <mat-form-field>
                            <mat-label>TTS Voice</mat-label>
                            <mat-select [ngModel]="getCharacterProperty('tts_voice', 'en-US-AvaMultilingualNeural')"
                                      (selectionChange)="onVoiceSelectionChange($event.value)">
                                @if (isCustomVoice(getCharacterProperty('tts_voice', 'en-US-AvaMultilingualNeural'))) {
                                    <mat-option [value]="getCharacterProperty('tts_voice', 'en-US-AvaMultilingualNeural')" style="font-style: italic">
                                        {{ getVoiceDisplayName(getCharacterProperty('tts_voice', 'en-US-AvaMultilingualNeural')) }}
                                    </mat-option>
                                    <mat-divider class="custom-voice-divider"></mat-divider>
                                }
                                <mat-optgroup label="English - United States">
                                    <mat-option value="en-US-AvaMultilingualNeural">Ava Multilingual (Female)</mat-option>
                                    <mat-option value="en-US-AndrewMultilingualNeural">Andrew Multilingual (Male)</mat-option>
                                    <mat-option value="en-US-AriaNeural">Aria (Female) - Positive, Confident</mat-option>
                                    <mat-option value="en-US-AnaNeural">Ana (Female) - Cute</mat-option>
                                    <mat-option value="en-US-ChristopherNeural">Christopher (Male) - Reliable, Authority</mat-option>
                                    <mat-option value="en-US-EricNeural">Eric (Male) - Rational</mat-option>
                                    <mat-option value="en-US-GuyNeural">Guy (Male) - Passion</mat-option>
                                    <mat-option value="en-US-JennyNeural">Jenny (Female) - Friendly, Considerate</mat-option>
                                    <mat-option value="en-US-MichelleNeural">Michelle (Female) - Friendly, Pleasant</mat-option>
                                    <mat-option value="en-US-RogerNeural">Roger (Male) - Lively</mat-option>
                                    <mat-option value="en-US-SteffanNeural">Steffan (Male) - Rational</mat-option>
                                </mat-optgroup>
                                <mat-optgroup label="English - United Kingdom">
                                    <mat-option value="en-GB-LibbyNeural">Libby (Female)</mat-option>
                                    <mat-option value="en-GB-MaisieNeural">Maisie (Female)</mat-option>
                                    <mat-option value="en-GB-RyanNeural">Ryan (Male)</mat-option>
                                    <mat-option value="en-GB-SoniaNeural">Sonia (Female)</mat-option>
                                    <mat-option value="en-GB-ThomasNeural">Thomas (Male)</mat-option>
                                </mat-optgroup>
                                <mat-optgroup label="English - Australia">
                                    <mat-option value="en-AU-NatashaNeural">Natasha (Female)</mat-option>
                                    <mat-option value="en-AU-WilliamNeural">William (Male)</mat-option>
                                </mat-optgroup>
                                <mat-option value="show-all-voices">Show All Voices...</mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>TTS Speed</mat-label>
                            <input matInput [ngModel]="getCharacterProperty('tts_speed', '1,2')"
                                   (ngModelChange)="onTraitChange('tts_speed', $event)">
                        </mat-form-field>
                    }
                    @if (config.tts_provider === "local-ai-server") {
                        <mat-form-field>
                            <mat-label>TTS Endpoint</mat-label>
                            <input matInput [(ngModel)]="config.tts_endpoint"
                                   (ngModelChange)="onConfigChange({tts_endpoint: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>TTS Voice</mat-label>
                            <input matInput [ngModel]="getCharacterProperty('tts_voice', 'nova')"
                                   (ngModelChange)="onTraitChange('tts_voice', $event)">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>TTS Speed</mat-label>
                            <input matInput [ngModel]="getCharacterProperty('tts_speed', '1,2')"
                                   (ngModelChange)="onTraitChange('tts_speed', $event)">
                        </mat-form-field>
                    }
                    @if (config.tts_provider === "custom") {
                        <mat-form-field>
                            <mat-label>TTS Endpoint</mat-label>
                            <input matInput [(ngModel)]="config.tts_endpoint"
                                   (ngModelChange)="onConfigChange({tts_endpoint: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>TTS Model Name</mat-label>
                            <input matInput [(ngModel)]="config.tts_model_name"
                                   (ngModelChange)="onConfigChange({tts_model_name: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>TTS Voice</mat-label>
                            <input matInput [ngModel]="getCharacterProperty('tts_voice', 'nova')"
                                   (ngModelChange)="onTraitChange('tts_voice', $event)">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>TTS Speed</mat-label>
                            <input matInput [ngModel]="getCharacterProperty('tts_speed', '1,2')"
                                   (ngModelChange)="onTraitChange('tts_speed', $event)">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>Override TTS API Key</mat-label>
                            <input matInput type="password" [(ngModel)]="config.tts_api_key"
                                   (ngModelChange)="onConfigChange({tts_api_key: $event})">
                        </mat-form-field>
                    }
                    @if (config.tts_provider === "none") {
                        <p>TTS is disabled</p>
                    }

                    <hr>
                    <h3>Vision Settings</h3>
                    <mat-form-field>
                        <mat-label>Vision Provider</mat-label>
                        <mat-select [(ngModel)]="config.vision_provider"
                                    (ngModelChange)="onConfigChange({vision_provider: $event, vision_var: $event !== 'none'})">
                            <mat-option value="openai">OpenAI</mat-option>
                            <mat-option value="google-ai-studio">Google AI Studio</mat-option>
                            <mat-option value="custom">Custom</mat-option>
                            <mat-option value="none">None</mat-option>
                        </mat-select>
                    </mat-form-field>

                    @if (config.vision_provider && config.vision_provider !== 'none') {
                        @if (config.vision_provider === "openai") {
                            <mat-form-field>
                                <mat-label>Vision Model Name</mat-label>
                                <input matInput [(ngModel)]="config.vision_model_name"
                                      (ngModelChange)="onConfigChange({vision_model_name: $event})">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Override Vision API Key</mat-label>
                                <input matInput type="password" [(ngModel)]="config.vision_api_key"
                                      (ngModelChange)="onConfigChange({vision_api_key: $event})">
                            </mat-form-field>
                        }

                        @if (config.vision_provider === "google-ai-studio") {
                            <mat-form-field>
                                <mat-label>Vision Model Name</mat-label>
                                <input matInput [(ngModel)]="config.vision_model_name"
                                      (ngModelChange)="onConfigChange({vision_model_name: $event})">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Override Vision API Key</mat-label>
                                <input matInput type="password" [(ngModel)]="config.vision_api_key"
                                      (ngModelChange)="onConfigChange({vision_api_key: $event})">
                            </mat-form-field>
                        }

                        @if (config.vision_provider === "custom") {
                            <mat-form-field>
                                <mat-label>Vision Endpoint</mat-label>
                                <input matInput [(ngModel)]="config.vision_endpoint"
                                      (ngModelChange)="onConfigChange({vision_endpoint: $event})">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Vision Model Name</mat-label>
                                <input matInput [(ngModel)]="config.vision_model_name"
                                      (ngModelChange)="onConfigChange({vision_model_name: $event})">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Override Vision API Key</mat-label>
                                <input matInput type="password" [(ngModel)]="config.vision_api_key"
                                      (ngModelChange)="onConfigChange({vision_api_key: $event})">
                            </mat-form-field>
                        }
                    }
                    @if (config.vision_provider === "none") {
                        <p>Vision is disabled</p>
                    }
                    @if (config && (config.commander_name || config.api_key)) {
                        <h3>Autostart</h3>
                        <mat-slide-toggle [(ngModel)]="config.cn_autostart"
                                (ngModelChange)="onConfigChange({cn_autostart: $event})">
                                Autostart assistant on application start
                        </mat-slide-toggle>
                    }
                    
                    @if (system?.os === 'Linux') {
                        <h3>Linux Settings</h3>
                        <p>Learn more about this setup <a target="_blank" rel="noopener noreferrer"
                                                          href="https://ratherrude.github.io/Elite-Dangerous-AI-Integration/advanced/linux/">here.</a>
                        </p>
                        <mat-form-field>
                            <mat-label>ED AppData Path</mat-label>
                            <input matInput [(ngModel)]="config.ed_appdata_path"
                                   (ngModelChange)="onConfigChange({ed_appdata_path: $event})">
                        </mat-form-field>
                        <mat-form-field>
                            <mat-label>ED Journal Path</mat-label>
                            <input matInput [(ngModel)]="config.ed_journal_path"
                                   (ngModelChange)="onConfigChange({ed_journal_path: $event})">
                        </mat-form-field>
                    }
                </div>
            }
        </div>
    </mat-tab>
    @if (system?.edcopilot_installed || has_plugin_settings) {
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon class="tab-icon">extension</mat-icon>
                Plugins
            </ng-template>
            <div class="tab-content">
                @if (config && system) {
                    @if (system.edcopilot_installed) {
                        <mat-expansion-panel>
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    <mat-icon fontSet="material-symbols-outlined" class="tab-icon">robot_2</mat-icon>
                                    EDCoPilot
                                </mat-panel-title>
                            </mat-expansion-panel-header>

                            <div class="settings-grid">
                                <mat-slide-toggle [(ngModel)]="config.edcopilot"
                                                (ngModelChange)="onConfigChange({edcopilot: $event})">
                                    Enable EDCoPilot Integration
                                </mat-slide-toggle>
                                @if (config.edcopilot) {
                                    <p>
                                        The EDCoPilot integration prevents both applications for talking at the same time.
                                        There are two modes of operation. <br>
                                        Learn more about this feature <a target="_blank" rel="noopener noreferrer"
                                                                        href="https://ratherrude.github.io/Elite-Dangerous-AI-Integration/50_EDCoPilot/">here.</a>
                                    </p>
                                    <p>Enabled:</p>
                                    <ul>
                                        <li>EDCoPilot will show COVAS:NEXT chat history</li>
                                        <li>COVAS:NEXT will generate responses</li>
                                    </ul>
                                    <p>COVAS:NEXT Dominant:</p>
                                    <ul>
                                        <li>EDCoPilot will be silent</li>
                                        <li>COVAS:NEXT low-latency Text-to-Speech is used</li>
                                    </ul>
                                    <p>EDCoPilot Dominant:</p>
                                    <ul>
                                        <li>EDCoPilot will generate responses</li>
                                        <li>COVAS:NEXT Text-to-Speech is disabled</li>
                                    </ul>

                                    <mat-form-field>
                                        <mat-label>Speech Output Application</mat-label>
                                        <mat-select [value]="config.edcopilot_dominant ? 'edcopilot' : 'covas'"
                                                    (selectionChange)="onConfigChange({edcopilot_dominant: $event.value === 'edcopilot'})">
                                            <mat-option value="covas">COVAS:NEXT Dominant</mat-option>
                                            <mat-option value="edcopilot">EDCoPilot Dominant</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                }
                            </div>
                        </mat-expansion-panel>
                    }
                    <app-plugin-settings></app-plugin-settings>
                }
            </div>
        </mat-tab>
    }
</mat-tab-group>

